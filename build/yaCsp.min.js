!function e(t,n,r){function i(o,c){if(!n[o]){if(!t[o]){var C="function"==typeof require&&require;if(!c&&C)return C(o,!0);if(u)return u(o,!0);var a=new Error("Cannot find module '"+o+"'");throw a.code="MODULE_NOT_FOUND",a}var s=n[o]={exports:{}};t[o][0].call(s.exports,function(e){var n=t[o][1][e];return i(n?n:e)},s,s.exports,e,t,n,r)}return n[o].exports}for(var u="function"==typeof require&&require,o=0;o<r.length;o++)i(r[o]);return i}({1:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=function(){function e(t,n,i){r(this,e),this.q=t,this.window=n,this.filter=i,this.loaded=!1}return i(e,[{key:"_compact",value:function(e){for(var t=-1,n=e?e.length:0,r=0,i=[];++t<n;){var u=e[t];u&&(i[r++]=u)}return i}},{key:"_loadPlugin",value:function(){this.cadesplugin=this.window.cadesplugin,this.CAPICOM_CURRENT_USER_STORE=this.cadesplugin.CAPICOM_CURRENT_USER_STORE,this.CAPICOM_MY_STORE=this.cadesplugin.CAPICOM_MY_STORE,this.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED=this.cadesplugin.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED,this.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME=this.cadesplugin.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME,this.CADESCOM_CADES_BES=this.cadesplugin.CADESCOM_CADES_BES,this.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN=this.cadesplugin.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN,this.loaded=!0}},{key:"_getCertDescription",value:function(e,t){var n=e.indexOf("CN="),r=e.indexOf(",",n),i=e.substring(n+3,r);return{title:i+"; Выдан "+this.filter("date")(t,"dd.MM.yyyy"),cn:e}}},{key:"getCertsList",value:function(){var e=this;this.loaded||this._loadPlugin();var t=void 0,n=void 0;return e.cadesplugin.CreateObjectAsync("CAPICOM.Store").then(function(n){return t=n,t.Open(e.CAPICOM_CURRENT_USER_STORE,e.CAPICOM_MY_STORE,e.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED),t.Certificates}).then(function(e){return n=e,e.Count}).then(function(t){if(!t)return e.q.reject("No certs found");for(var r=[],i=new Date,u=1;t>=u;u++)!function(t){r.push(e.q(function(r,u){var o=void 0,c=void 0,C=void 0;return n.Item(t).then(function(e){return o=e,o.ValidToDate}).then(function(e){return c=new Date(e),o.IsValid()}).then(function(e){return e.Result}).then(function(e){return C=e,o.HasPrivateKey()}).then(function(t){return t&&C&&c>i?o.SubjectName.then(function(t){return r(e._getCertDescription(t,c))}):r(null)})}))}(u);return e.q.all(r).then(function(t){return e._compact(t)})})}},{key:"sign",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"Hello World":arguments[0],t=arguments.length<=1||void 0===arguments[1]?"":arguments[1],n=this;this.loaded||this._loadPlugin();var r=void 0,i=void 0,u=void 0,o=void 0,c=void 0;return n.cadesplugin.CreateObjectAsync("CAPICOM.Store").then(function(e){return r=e,r.Open(n.CAPICOM_CURRENT_USER_STORE,n.CAPICOM_MY_STORE,n.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED),r.Certificates}).then(function(e){return t?e.Find(CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME,t):e}).then(function(e){return i=e,e.Count}).then(function(e){return e?e>1?n.q.reject("Specify certificate name. Found: "+e+" certs"):n.q.resolve():n.q.reject("No certs found")}).then(function(){return i.Item(1)}).then(function(e){u=e}).then(function(){return n.cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner")}).then(function(e){return o=e,o.propset_Certificate(u)}).then(function(){return n.cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData")}).then(function(t){return c=t,c.propset_Content(e)}).then(function(){return o.propset_Options(n.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN)}).then(function(){return c.SignCades(o,n.CADESCOM_CADES_BES)}).then(function(e){return r.Close(),e})}}]),e}();u.$inject=["$q","$window","$filter"],n["default"]=u},{}],2:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var i=e("./services/cspWrap.service"),u=r(i);angular.module("ya.csp",[]).service("ya.csp.WrapService",u["default"])},{"./services/cspWrap.service":1}]},{},[2]);
//# sourceMappingURL=yaCsp.min.js.map
